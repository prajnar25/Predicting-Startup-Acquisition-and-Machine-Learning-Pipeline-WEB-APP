{% extends "base.html" %}

{% block title %}Batch Prediction Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 text-center mb-4">
        <h2>
            <i class="fas fa-table text-primary me-2"></i>
            Batch Prediction Results
        </h2>
        <p class="text-muted">{{ task_type.title() }} Classification for {{ total_rows }} rows</p>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <h4 class="text-primary">{{ total_rows }}</h4>
                        <p class="mb-0">Total Predictions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <h4 class="text-success">
                            {{ "%.1f"|format((results | selectattr('confidence', 'greaterthan', 0.8) | list | length) / total_rows * 100) }}%
                        </h4>
                        <p class="mb-0">High Confidence</p>
                        <small class="text-muted">(>80%)</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <h4 class="text-info">{{ task_type.title() }}</h4>
                        <p class="mb-0">Model Type</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card feature-card text-center">
                    <div class="card-body">
                        <h4 class="text-warning">
                            {{ "%.1f"|format(results | map(attribute='confidence') | sum / total_rows * 100) }}%
                        </h4>
                        <p class="mb-0">Avg Confidence</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="card feature-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Detailed Results
                </h5>
                <div>
                    <button class="btn btn-outline-primary btn-sm" onclick="downloadCSV()">
                        <i class="fas fa-download me-1"></i>Download CSV
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                        <i class="fas fa-print me-1"></i>Print
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="resultsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Row #</th>
                                <th>Prediction</th>
                                <th>Class Label</th>
                                <th>Confidence</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>{{ result.row }}</td>
                                <td>
                                    <span class="badge bg-primary">Class {{ result.prediction }}</span>
                                </td>
                                <td>{{ result.prediction_label }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="progress me-2" style="width: 80px; height: 20px;">
                                            <div class="progress-bar 
                                                {% if result.confidence > 0.8 %}bg-success
                                                {% elif result.confidence > 0.6 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                role="progressbar" 
                                                data-width="{{ result.confidence * 100 }}">
                                            </div>
                                        </div>
                                        <span class="small">{{ "%.1f"|format(result.confidence * 100) }}%</span>
                                    </div>
                                </td>
                                <td>
                                    {% if result.confidence > 0.8 %}
                                        <span class="badge bg-success">High</span>
                                    {% elif result.confidence > 0.6 %}
                                        <span class="badge bg-warning">Medium</span>
                                    {% else %}
                                        <span class="badge bg-danger">Low</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="text-center mt-4">
            <a href="/" class="btn btn-gradient btn-lg me-3">
                <i class="fas fa-arrow-left me-2"></i>Upload Another File
            </a>
            <button class="btn btn-outline-primary btn-lg" onclick="showStatistics()">
                <i class="fas fa-chart-bar me-2"></i>View Statistics
            </button>
        </div>
    </div>
</div>

<!-- Statistics Modal -->
<div class="modal fade" id="statisticsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-pie me-2"></i>Prediction Statistics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="predictionChart" width="300" height="200"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="confidenceChart" width="300" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Results data for JavaScript
const resultsData = {{ results | tojson }};

function downloadCSV() {
    const headers = ['Row', 'Prediction', 'Class Label', 'Confidence', 'Status'];
    const csvContent = [
        headers.join(','),
        ...resultsData.map(r => [
            r.row,
            r.prediction,
            '"' + r.prediction_label + '"',
            r.confidence.toFixed(4),
            r.confidence > 0.8 ? 'High' : r.confidence > 0.6 ? 'Medium' : 'Low'
        ].join(','))
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'batch_predictions.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function showStatistics() {
    const modal = new bootstrap.Modal(document.getElementById('statisticsModal'));
    modal.show();
    
    // Create prediction distribution chart
    setTimeout(() => {
        createPredictionChart();
        createConfidenceChart();
    }, 300);
}

function createPredictionChart() {
    const ctx = document.getElementById('predictionChart').getContext('2d');
    
    // Count predictions by class
    const predictionCounts = {};
    resultsData.forEach(r => {
        predictionCounts[r.prediction] = (predictionCounts[r.prediction] || 0) + 1;
    });
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(predictionCounts).map(k => `Class ${k}`),
            datasets: [{
                data: Object.values(predictionCounts),
                backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Prediction Distribution'
                }
            }
        }
    });
}

function createConfidenceChart() {
    const ctx = document.getElementById('confidenceChart').getContext('2d');
    
    // Create confidence bins
    const bins = { 'Low (0-60%)': 0, 'Medium (60-80%)': 0, 'High (80-100%)': 0 };
    resultsData.forEach(r => {
        if (r.confidence <= 0.6) bins['Low (0-60%)']++;
        else if (r.confidence <= 0.8) bins['Medium (60-80%)']++;
        else bins['High (80-100%)']++;
    });
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(bins),
            datasets: [{
                label: 'Number of Predictions',
                data: Object.values(bins),
                backgroundColor: ['#FF6384', '#FFCE56', '#36A2EB']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Confidence Distribution'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Animate progress bars on load
document.addEventListener('DOMContentLoaded', function() {
    const progressBars = document.querySelectorAll('.progress-bar');
    progressBars.forEach((bar, index) => {
        const targetWidth = bar.getAttribute('data-width');
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = targetWidth + '%';
        }, 100 + (index * 20));
    });
});
</script>
{% endblock %}
